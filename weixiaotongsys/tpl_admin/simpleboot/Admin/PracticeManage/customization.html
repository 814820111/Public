<admintpl file="header" />
<script src="__ROOT__/statics/js/layer/layer.js" type="text/javascript"></script>
<body class="J_scroll_fixed">
<div class="wrap J_check_wrap">
    <ul class="nav nav-tabs">
        <li class="active"><a href="{:U('index')}">业务定制</a></li>
        <!-- <li><a href="{:U('Notice/add')}">新增班级相册</a></li> -->
        <!-- <li><a href="{:U('schoolcheck')}">学校审核</a></li> -->
    </ul>
    <div class="common-form">
        <fieldset>
            <div class="search_type cc mb10">
                <div class="mb10">
                    <span class="mr20">
                        省份选择：
                        <select  class="province"  name="province" id="province" style="width: auto;">
                            <option value="">&nbsp;&nbsp;
                     
                                省级选择&nbsp;
                                &nbsp;
                       
                            </option>
                            <foreach name="Province" item="vo">
                                <php>$pro=$province==$vo['term_id']?"selected":"";</php>
                                <option value="{$vo.term_id}"{$pro}>{$vo.name}</option>
                            </foreach>
                        </select>&nbsp;&nbsp;
                        <input type="hidden" class="new_citys" value="{$new_citys}">
                        市级:
                        <select class="select_1" name="citys" id="citys" style="width: auto;">
            
                            <option value="0" selected>请先选择省份</option>
                               
                        </select> &nbsp;&nbsp;
                        <input type="hidden" class="new_message_type" value="{$new_message_type}">
                        区级:
                        <select class="select_3" name="message_type" id="message_type" style="width: auto;">
                            <option value="0">请选择你的区域</option>
                        </select> &nbsp;&nbsp;
                        学校：
                        <select id="school" style="width: auto;">
                            <option value="" >请选择学校</option>
                        </select><br>
       
                        <span class="mr20" >
                            班级选择：
                            <span style="width: 45%; margin-top: 13px; ">
                                <select id="classname" name="classid" style="width: auto;">

                                    <option value="0"> &nbsp;&nbsp; 班级选择 &nbsp;&nbsp; </option>
                                </select>&nbsp;&nbsp;
                            </span>
                            营销方案:
                            <select id="package" name="classid" style="width: auto;">
                                <option value="0">请选择</option>
                               <foreach name = "meal" item="vo">
                                 <option value="{$vo.id}" data-type="{$vo.time_type}">{$vo.name}</option>
                               </foreach>
                            </select>&nbsp;&nbsp;
                            类型:
                            <span id="types">
                              （请选择营销方案）
                            </span>
                            操作:
                             <input type="radio" name="operation" value="1" style="vertical-align: -1px;">开通&nbsp;
                             <input type="radio" name="operation" value="3" style="vertical-align: -1px;">取消&nbsp;
                             <input type="radio" name="operation" value="2" style="vertical-align: -1px;">转收费&nbsp;
                            是否收费:
                            <select id="toll" style="width: auto;">
                                <option value="1">免费</option>
                            </select><br>
                                 条件选择：
                   <span style="width: 45%; margin-top: 13px; ">
						<select class="tiaojian" name="tiaojian" style="width: auto;">

						    <option value="0">&nbsp;&nbsp;

                        查询类型&nbsp;
                        &nbsp;</option>

							<option value="stu_name"  >学生名字</option>

                            <option value="charging_phone" >扣费号码</option>

                            <option value="name" >家长名字</option>

                            <option value="phone" >家长号码</option>
						</select>
				            <input type="text" placeholder="根据条件进行模糊查询" name="shuzhi" class="zhi"/ value="{$shuzhi}" style="width: 150px;">

						</span>
                            订购状态 :&nbsp;&nbsp;
                            <select id="order" name="order" style="width: auto;">
                                <option value="0">全部</option>
                                <option value="1">已订购免费的</option>
                                <option value="2">已订购收费的</option>
                                <option value="4">已退订</option>



                            </select>&nbsp;&nbsp;
                            最后变更时间 : <input placeholder="请选择时间" class="stu-select-inputlist" name="begin" type="text" onfocus="(this.type='date')"  id="time" style="width: 135px;">-<input placeholder="请选择时间" class="stu-select-inputlist" name="end" type="text" onfocus="(this.type='date')"  id="time" style="width: 135px;">
                            <br>
                             班级选择： <input type="text" id="desc">
                            <div style="       display: inline-block;
    margin-top: 8px; ">
                                <button type="button" class="btn btn-primary" id="chaxun" style='margin-top: -10px;'>查询</button>&nbsp;&nbsp;
                        
    
                        
                        
    
                                <a class="btn btn-danger" href="{:U('customization')}" style='margin-top: -10px;'>清空</a>&nbsp;&nbsp;
                                <button type="button" class="btn btn-success" id="caozuo" style='margin-top: -10px;'>操作所选</button>&nbsp;

        
                                <!-- <a class="btn btn-danger drop" >退学</a> -->
                            </div>
                        </span>


                    </span>
                </div>
            </div>
            <div style="clear: both"></div>
        </fieldset>
    </div>

    <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width: 730px; left: 45%;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"  style="background: white">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h5 class="modal-title" id="myModalLabel" style="color: black; font-weight:bold;"></span>&nbsp;修改号码</h5>
                </div>
                <div class="modal-body" style="max-height: 300px;     overflow-y: auto;">

                    <input type="hidden" class="school">
                    <div>

                    </div>
                    <form class="">
                        <div style=" margin-top:30px; margin-bottom:15px; margin-left:30px;" class="numberic">


                            <div class="clearfix"></div>
                        </div>
                        <div style=" margin-bottom:10px; margin-left:30px;">
                            <form>

                                <div style=" margin-top:8px;">
                                    <div style=" float:left; width:14px; height:14px; border-radius:50%; background-color:#e84e40; margin-top:3px; margin-right:10px;"></div>
                                    <div style=" float:left;">该栏目填写的是学生亲属号码以及扣费号码</div>
                                    <div class="clearfix"></div>
                                </div>
                                <div style=" margin-top:8px; margin-bottom:13px;">
                                    姓名：<span class="stuhuan" style="color:#3a87ad;"></span><span style=" margin-left:20px; margin-right:20px;"></span>

                                </div>
                                手机号码：<input type="text" name="sole_number"  class="sole_number" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:108px;" placeholder="请输入内容" value="">
                                扣费号码：<input type="text" name="fee_number"  class="fee_number" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:108px;" placeholder="请输入内容" value="">
                                <!--<div style=" margin-bottom:20px;">-->
                                    <!--扣费号码：-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">姓名</span>-->
                                    <!--<input type="text" name="qinshuxingming1" class="qinshuxingming0" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:90px;" placeholder="请输入内容" value="">-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">号码 </span>-->
                                    <!--<input type="text" name="qinshuhaoma1"  class="qinshuhaoma0" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:108px;" placeholder="请输入内容" value="">-->
                                    <!--<input type="hidden" name="oldhaoma1"  class="oldhaoma0" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:200px;" placeholder="请输入内容" value="">-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">关系</span>-->

                                    <!--<input type="text" name="qinshuguanxi1"  class="qinshuguanxi0" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:106px;" placeholder="请输入内容" >-->
                                <!--</div>-->

                                <!--<div style=" margin-bottom:20px;">-->
                                    <!--亲情卡号一：-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">姓名</span>-->
                                    <!--<input type="text" name="qinshuxingming1" class="qinshuxingming0" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:90px;" placeholder="请输入内容" value="">-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">号码 </span>-->
                                    <!--<input type="text" name="qinshuhaoma1"  class="qinshuhaoma0" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:108px;" placeholder="请输入内容" value="">-->
                                    <!--<input type="hidden" name="oldhaoma1"  class="oldhaoma0" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:200px;" placeholder="请输入内容" value="">-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">关系</span>-->

                                    <!--<input type="text" name="qinshuguanxi1"  class="qinshuguanxi0" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:106px;" placeholder="请输入内容" >-->
                                <!--</div>-->
                                <!--<div style=" margin-bottom:20px;">-->
                                    <!--亲情卡号二：-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">姓名</span>-->
                                    <!--<input type="text" name="qinshuxingming2"  class="qinshuxingming1" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:90px;" placeholder="请输入内容">-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">号码 </span>-->
                                    <!--<input type="text" name="qinshuhaoma2" class="qinshuhaoma1"  style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:108px;" placeholder="请输入内容">-->
                                    <!--<input type="hidden" name="oldhaoma2"  class="oldhaoma1" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:200px;" placeholder="请输入内容" value="">-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">关系</span>-->
                                    <!--<input type="text" name="qinshuguanxi2"  class="qinshuguanxi1" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:106px;" placeholder="请输入内容" >-->
                                <!--</div>-->
                                <!--<div style=" margin-bottom:20px;">-->
                                    <!--亲情卡号三：-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">姓名</span>-->
                                    <!--<input type="text" name="qinshuxingming3"  class="qinshuxingming2" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:90px;" placeholder="请输入内容">-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">号码 </span>-->
                                    <!--<input type="text" name="qinshuhaoma3"  class="qinshuhaoma2" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:108px;" placeholder="请输入内容">-->
                                    <!--<input type="hidden" name="oldhaoma3"  class="oldhaoma2" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:200px;" placeholder="请输入内容" value="">-->
                                    <!--<span style=" margin-left:10px; margin-right:5px;">关系</span>-->
                                    <!--<input type="text" name="qinshuguanxi3"  class="qinshuguanxi2" style="margin-bottom:10px; margin-top: 5px; margin-left:5px; width:106px;" placeholder="请输入内容" >-->
                                <!--</div>-->

                            </form>
                        </div>

                        <div style=" width:60px; margin-left:auto; margin-right:auto; margin-top:20px;">
                            <!--<input type="submit" value="保&nbsp;存" style=" border:none; background-color:#26a69a; color:white; border-radius:3px; padding:5px 15px 5px 15px;" '>-->

                        </div>
                    </form>


                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-default guan1" data-dismiss="modal" style="background: white; color:black; font-weight:bold;">关闭</button>
                    <button type="button" class="btn btn-primary " style="display: block;float: right;font-weight:bold;" onclick='sub_qinshu()'>提交更改</button>


                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal -->
    </div>



    <table class="table table-hover table-bordered aa">
        <thead>
        <tr>
            <th >全选<input type="checkbox" id='checkAll' style="    vertical-align: -3px;"></th>
            <th>学校</th>
            <th>所属SA</th>
            <th>班级</th>
            <th>姓名</th>
            <th>家长手机</th>
            <th>扣费号码</th>

            <th  title="开通情况">
                <table class="" width="100%" border="0" cellspacing="0" cellpadding="0" style="    position: relative;
    top: 9px;">
                    <thead>

                      <tr>
                        <th width="25%" style="    border: none;">服务</th>
                        <td width="15%" style="    border: none;">开通状态</td>
                        <td width="15%" style="    border: none;">订购状态</td>
                        <td width="25%" style="    border: none;">最后变更时间</td>
                        <td width="20%" style="    border: none;">创建时间</td>
                      </tr>
                    </thead>
                </table>
            </th>
            <!--<th>开通状态</th>-->
            <!--<th>订购状态</th>-->
            <!--<th>修改时间</th>-->

            <!--<th>操作</th>-->


            <!--          <th>发送进度</th>
                <th>操作</th>
                <th>档案进度</th> -->
             
        </tr>
        </thead>
        <tbody class="cc">
        <!--<tr><td>1</td><td>1</td><td><img width="30" height="30" src="__ROOT__uploads/avatar/{$vo.photo}" /></td><td>1</td><td>1</td></tr>-->
        </tbody>
    </table>



           
    <div class="pagination">{$Page}</div>

       
</div>
<script src="__ROOT__/statics/js/common.js"></script>
<script>
    $(document).ready(function () {
        $("#message_type").val(0);
        $("#citys").val(0);
        $("#school").val(0);
        $("#gradename").val(0);
    });
    //选择市级的下拉的ajax
    $(function() {
        $("#province").change(function(){


            $.getJSON("__ROOT__/index.php?g=Admin&m=AdminUtils&a=role_type&Province="+$("#province").val(),{},function(data){
                $("#citys").empty()
                   
                if(data.status=="success"){
                      
                    $("#citys").append("<option value=>"+"请选择市级"+"</option>");
                    for(var key in data.data){
                        $("#citys").append("<option value="+data.data[key]["term_id"]+">"+data.data[key]["name"]+"</option>");
                    }
                }
                if(data.status=="error"){
                    $("#citys").append("<option value=''>没有市级</option>");
                }
            });


})
    });


    $(function() {
        $("#citys").change(function() {
            console.log($("#citys").val())
            $("#message_type").empty();
            // $("#student").empty();
              
            $("#message_type").append("<option value=>"+"请选择区域"+"</option>");
            $.getJSON("__ROOT__/index.php?g=Admin&m=AdminUtils&a=Provinces&Province="+$("#citys").val(),{},function(data){
                console.log(data);
                if(data.status=="success"){
                      
                    // $("#message_type").append("<option value=>"+"请选择区域"+"</option>");
                    for(var key in data.data){
                        $("#message_type").append("<option value="+data.data[key]["term_id"]+">"+data.data[key]["name"]+"</option>");
                    }
                }
                if(data.status=="error"){
                    $("#message_type").append("<option value='0'>暂无区域</option>");
                }
            });
        });
    });




    $(".select_3").change(function() {

        var type = $(".select_3  option:selected").val();
        $("#school").empty();
        $.ajax({
            type: "post",
            url: '__ROOT__/index.php/?g=Admin&m=AdminUtils&a=lookup',
            async: true,
            data: {
                type: type
            },
            dataType: 'json',
            success: function(res) {
                $(".Sio").text("")
                var html = "";
                res = eval(res.data);
                for(var i = 0; i < res.length; i++) {
                    var school_name = res[i].school_name; //学校的名字
                    var schoolid = res[i].schoolid; //学校的ID
                    html += '<option class="Sio" value="' + schoolid + '">' + school_name + ' </option> '
                }
                $("#school").append("<option value=''>请选择学校</option>");
                $("#school").append(html)
                $("#viewOLanguage").chosen();
                $("#viewOLanguage").trigger("liszt:updated");
            },
            error: function() {
                console.log('系统错误,请稍后重试');
            }
        });
    })

    $("#school").change(function(){
        $("#classname").empty();
             
            
        $.getJSON("__ROOT__/index.php?g=admin&m=AdminUtils&a=schoolclass&schoolid="+$("#school").val(),{},function(data){
            if(data.status=="success"){
                $("#classname").append("<option value=''>请选择班级</option>");
                for(var key in data.data){
                    $("#classname").append("<option value="+data.data[key]["id"]+">"+data.data[key]["classname"]+"</option>");
                }
            }
            if(data.status=="error"){
                $("#classname").append("<option value='0'>没有班级</option>");
            }
        });



    })

$("#package").change(function(){
    var type = $(this).find("option:selected").attr("data-type");
    var html="";
    var obj=document.getElementsByName('operation');

    var opt="";
    for(var i=0; i<obj.length; i++){
        if(obj[i].checked){
            opt+=obj[i].value;
        }
    }

if(opt==2 || opt=='')
{
    if(type==1){
        html+='<input type="radio" value="1" checked="checked" name="opt_type" style=" vertical-align: -2px;"><span>月:</span>';
        html+='<input type="text" name="month" style="width:50px;">'
        $("#types").html(html);

    }

    if(type==2){
        html+='<input type="radio" value="2" checked="checked" name="opt_type" style=" vertical-align: -2px;"><span>学期</span>';

        $("#types").html(html);

    }
    if(type==3){
        html+='<input type="radio" value="3" checked="checked" name="opt_type" style=" vertical-align: -2px;"><span>季度</span>';

        $("#types").html(html);

    }
    if(type==4){
        html+='<input type="radio" value="4" checked="checked" name="opt_type" style=" vertical-align: -2px;"><span>学年</span>';

        $("#types").html(html);

    }
}




})

    $("input[name='operation']").click(function(){
      var num = $(this).val();

        var type = $("#package").find("option:selected").attr("data-type");
        var html="";
      if(num!=2)
      {
          $("#types").html(html);
       }else{
          if(type==1){
              html+='<input type="radio" value="1" checked="checked" name="opt_type" style=" vertical-align: -2px;"><span>月:</span>';
              html+='<input type="text" name="month" style="width:50px;">'
              $("#types").html(html);

          }

          if(type==2){
              html+='<input type="radio" value="2" checked="checked" name="opt_type" style=" vertical-align: -2px;"><span>学期</span>';

              $("#types").html(html);

          }
          if(type==3){
              html+='<input type="radio" value="3" checked="checked" name="opt_type" style=" vertical-align: -2px;"><span>季度</span>';

              $("#types").html(html);

          }
          if(type==4){
              html+='<input type="radio" value="4" checked="checked" name="opt_type" style=" vertical-align: -2px;"><span>学年</span>';

              $("#types").html(html);

          }
      }


    })
    //显示号码

//    $(document).on("click",".daibanzhuren1 ",function(){
//
//    })
    $("#myModal1").hide();
    $(document).on("click",".daibanzhuren1 ",function(){

        phone_obj = $(this);

        console.log(phone_obj);

        layer.load();

            $(".sole_number").val('');
            $(".fee_number").val('');
            $('.qinshuxingming0').val('')
            $('.qinshuxingming1').val('')
            $('.qinshuxingming2').val('')
            $('.qinshuhaoma0').val('')
            $('.oldhaoma0').val('')
            $('.qinshuhaoma1').val('')
            $('.oldhaoma1').val('')
            $('.qinshuhaoma2').val('')
            $('.oldhaoma2').val('')
            $('.qinshuguanxi0').val('')
            $('.qinshuguanxi1').val('')
            $('.qinshuguanxi2').val('')



            stud = $(this).parent().parent().find("td:eq(0)").find("input").val();

            // $(".chuanzhi").val(stud)
            var stuname = $(this).parent().parent().find("td:eq(4)").text()

            $(".stuhuan").text(stuname)
            var stuid = $(this).parent().siblings(".stuid").text();
            $(".stuhua").text(stuid);



            $.ajax({
                type: "get",
                async: false,
                dataType:'json',
                url: "{:U('Admin/PracticeManage/showqinshu')}",
                data: {
                    studentid:stud,


                },
                success: function(data) {


                    if(data.status){
                        setTimeout(function(){
                            layer.closeAll('loading');
                        });
                        $("#myModal1").modal("show")
                        for(var i = 0; i < data.msg.length; i++) {


                            var name = data.msg[i].name; //姓名；
                            var phone = data.msg[i].phone; //手机
                            var relation = data.msg[i].appellation//关系
                            // console.log(relation);


                            var j = "qinshuxingming" + i;

                            var k = "qinshuhaoma" + i;

                            var c = "qinshuguanxi"+i;

                            var d = "oldhaoma"+i;
                            // console.log(c);

                            var test = document.getElementsByClassName(j);
                            var hest = document.getElementsByClassName(k);
                            var old =  document.getElementsByClassName(d);
                            var rela = document.getElementsByClassName(c);

                            // console.log(rela);



                            // console.log(test);
                            $(test).val(name);

                            // $(test).attr('data-id',id);

                            $(old).val(phone);

                            $(hest).val(phone);

                            $(rela).val(relation);
                        }

                        $(".fee_number").val(data.load['charging_phone']);
                        $(".sole_number").val(data.load['parent_phone']);


                    }else{
                        alert(data.info);
                    }
                },
                //请求失败
                error:function(){
                    alert('请求失败');
                }
            });


        }
    )

    function sub_qinshu() {

        var studentid = stud;

        var schoolid = $("#school").val();

        var load =   $("input[name='fee_number']").val();

        var sole_num =  $("input[name='sole_number']").val();



        if($("input[name='qinshuxingming1']").val() && $("input[name='qinshuhaoma1']").val() && $("input[name='qinshuguanxi1']").val())
        {

            var arr1 = new Array();
            arr1[0] = $("input[name='qinshuxingming1']").val();
            arr1[1] = $("input[name='qinshuhaoma1']").val();
            arr1[2] = $("input[name='qinshuguanxi1']").val();
            arr1[3] = $("input[name='oldhaoma1']").val();
        }

        if($("input[name='qinshuxingming2']").val() && $("input[name='qinshuhaoma2']").val() && $("input[name='qinshuguanxi2']").val())
        {
            var arr2 = new Array();
            arr2[0] = $("input[name='qinshuxingming2']").val();
            arr2[1] = $("input[name='qinshuhaoma2']").val()
            arr2[2] = $("input[name='qinshuguanxi2']").val();
            arr2[3] = $("input[name='oldhaoma2']").val();
        }



        if($("input[name='qinshuxingming3']").val() && $("input[name='qinshuhaoma3']").val() && $("input[name='qinshuxingming3']").val())
        {

            var arr3 = new Array();
            arr3[0] = $("input[name='qinshuxingming3']").val();
            arr3[1] = $("input[name='qinshuhaoma3']").val();
            arr3[2] = $("input[name='qinshuguanxi3']").val();
            arr3[3] = $("input[name='oldhaoma3']").val();
        }

        $.ajax({
            type: "get",
            async: false,
            dataType:'json',
            url: "{:U('Admin/PracticeManage /qinshu')}",
            data: {
                'qinshu1[]': arr1,
                'qinshu2[]': arr2,
                'qinshu3[]': arr3,
                'studentid': studentid,
                'schoolid':schoolid,
                'load':load,
                'sole_num':sole_num,
            },
            success: function(msg) {

                if(msg.status)
                {
                    layer.msg('修改成功', {
                        icon: 1
                        ,shade: 0.01,
                    });
                    $("#myModal1").modal('hide');
                    phone_obj.text(sole_num);

                }else{
                    alert(msg.info);
                }


            },
            //请求失败
            error:function(){
                alert('请求失败');
            }
        });
    }




//          $("#gradename").change(function(){
//             $("#classname").empty();
//
//           $.getJSON("__ROOT__/index.php?g=admin&m=AdminUtils&a=showclass&schoolid="+$("#school").val()+'&gradeid='+$("#gradename").val(),{},function(data){
//
//                if(data.status=="success"){
//                    $("#classname").append("<option value=''>请选择班级</option>");
//                for(var key in data.data){
//                    $("#classname").append("<option value="+data.data[key]["id"]+">"+data.data[key]["classname"]+"</option>");
//                }
//                }
//                if(data.status=="error"){
//                    $("#classname").append("<option value='0'>没有年级</option>");
//                }
//            });
//
//
//
//    })
    $("input[name='operation']").click(function(){
      var oid  =  $(this).val();

      if(oid==1)
      {
          $('#toll').show();
      }else{
          $('#toll').hide();
      }

    })
    function contains(arr, obj) {
        var i = arr.length;
        while (i--) {
            if (arr[i] === obj) {
                return true
            }
        }
        return false;
    }
    //来判断已开通的业务
    function is_contains(arr, obj,name) {
        var i = arr.length;
        while (i--) {
            if (arr[i] === obj) {
                return name[i];
            }
        }
        return false;
    }

    $("#caozuo").click(function(){
        var package_name = $('#package').find("option:selected").text();



        var pacid = $("#package").val();

        var schoolid = $("#school").val();

//        return false;

        var obj=document.getElementsByName('operation');

        var package_name = $('#package option:selected').text();

        var status = 1;



        var type="";
        for(var i=0; i<obj.length; i++){
            if(obj[i].checked){
                type+=obj[i].value;
            }
        }




        var str = 0;
        var id = tag = '';

        var obj = new Array();

        $(".aa").find("input[name='ids[]']").each(function() {
            if ($(this).attr('checked')) {
                str = 1;
                id += tag + $(this).val();
                tag = ',';
            }
        });



        if(str=='')
        {
            alert("请选择");
            return false;
        }

        if(pacid==0)
        {
            alert("请选择套餐");
            return false;
        }


        if(type==''){
            alert("请选择收取方式");
            return false;
        }

        if(type==2 || type==3)
        {
//            var stu_name = '';
            var istrue = true;
            $(".aa").find("input[name='ids[]']").each(function() {
                if ($(this).attr('checked')) {
                    var arr = new Array();
//                    var name = new Array();
                    $(this).parent().parent().find("td:eq(7)").find(".tds").each(function() {
                        arr.push($(this).text());
//                        name.push($(this).parent().parent().parent().parent().parent().find("td:eq(4)").text());

                    });
//                    console.log(arr);
                    var aa =  contains(arr, package_name);
                    if(!aa)
                    {

                        istrue = false;
                    }


                }
            });
           if(!istrue)
           {
               alert("该学生没有订购该套餐,请仔细核对过再操作!");
               return false;
           }

        }

        if(type==1)
        {

            var stu_name = '';
            var istrue = true;
            $(".aa").find("input[name='ids[]']").each(function() {
                if ($(this).attr('checked')) {
                    var arr = new Array();

                    var name = new Array();

                    $(this).parent().parent().find("td:eq(7)").find(".tds").each(function() {
                        arr.push($(this).text());
                        name.push($(this).parent().parent().parent().parent().parent().find("td:eq(4)").text());


                    });


                    var aa =  is_contains(arr, package_name,name);




                    if(aa)
                    {
                       stu_name = aa;
                        istrue = false;
                    }


                }
            });




            if(!istrue)
            {
                alert(stu_name+"已经订购该套餐,请勿重复开通!");
                return false;
            }
        }


        cust_operation(id,pacid,type,status,schoolid);
//        $.ajax({
//            type:"get",
//            async:false,
//            url:"{:U('customization_operation')}",
//            data:{'id': id,'tryoutmonth':tryoutmonth},
//            dataType:"json",
//            success: function(data){
//                if(data.status == 'success'){
//                    layer.msg('操作成功', {
//                        icon: 1
//                        ,shade: 0.01,
//                    });
//                    $(".aa").find("input[name='ids[]']").each(function() {
//                        if ($(this).attr('checked')) {
//
//                            $(this).parent().parent().find("td:eq(9)").text(cc);
//
//                        }
//                    });
//
//                }else{
//                    alert("data.info");
//                }
//            }
//        });



});

    function cust_operation(id,pacid,type,status,schoolid)
    {
        var date = new Date(+new Date()+8*3600*1000).toISOString().replace(/T/g,' ').replace(/\.[\d]{3}Z/,'');
        var package_name = $('#package').find("option:selected").text();

        var obj=document.getElementsByName('opt_type');

        var desc = $("#desc").val();

        var opt="";
        for(var i=0; i<obj.length; i++){
            if(obj[i].checked){
                opt+=obj[i].value;
            }
        }




        $.ajax({
            type:"get",
            async:false,
            url:"{:U('customization_operation')}",
            data:{'id': id,'pacid':pacid,'use_status':type,'status':status,'schoolid':schoolid,'time_type':opt,'month':$("input[name='month']").val(),'desc':desc},
            dataType:"json",
            success: function(data){
                if(data.status == 'success'){
                    layer.msg('操作成功', {
                        icon: 1
                        ,shade: 0.01,
                    });

                    if(type==1)
                    {
                        $(".aa").find("input[name='ids[]']").each(function() {
                            if ($(this).attr('checked')) {
                                var arr = new Array();

                                $(this).parent().parent().find("td:eq(7)").find(".tds").each(function() {
                                    arr.push($(this).text());
//

                                });

                                var aa =  contains(arr, package_name);
                                if(aa)
                                {


                                    $(this).parent().parent().find("td:eq(7)").find(".tds").each(function() {

                                    if($(this).text()==package_name)
                                    {
                                        $(this).next().text('开通');
                                        $(this).next().next().text('免费');
                                        $(this).next().next().next().text(date);
                                        return true;
                                    }

                                    });
                                }else{
                                                                            var html=' ';
                                        var obj = $(this).parent().parent().find("td:eq(7)").find("thead");


                                        html+='<tr>';
                                        html+='<td width="25%" style="border: none;" class=tds>'+package_name+'</td>';
                                        html+='<td width="15%" style="   border: none;">开通</td>';
                                        html+='<td width="15%" style="    border: none;">免费</td>';
                                        html+='<td width="20%" style="    border: none;">'+date+'</td>';
                                        html+='<td width="25%" style="    border: none;">'+date+'</td>';
                                        html+='</tr>';


                                        obj.append(html);
                                }
//
                                $(this).attr("checked", false);

                            }
                        });

                    }
                    if(type==2)
                    {
                        $(".aa").find("input[name='ids[]']").each(function() {
                            if ($(this).attr('checked')) {

                                var tds = $(this).parent().parent().find("td:eq(7)").find(".tds");
                                for (var i=0;i<tds.length;i++){
                                    console.log(tds.eq(i).text());
                                    if(tds.eq(i).text()==package_name)
                                    {
                                        tds.eq(i).next().text("转收费");
                                        tds.eq(i).next().next().text("收费");
                                        tds.eq(i).next().next().next().text(date);
                                    }

                                }


                            }
                        });
                    }
                    if(type==3)
                    {
                        $(".cc").find("input[name='ids[]']").each(function() {
                            if ($(this).attr('checked')) {

                                var tds = $(this).parent().parent().find("td:eq(7)").find(".tds");
                                for (var i=0;i<tds.length;i++){
                                    console.log(tds.eq(i).text());
                                    if(tds.eq(i).text()==package_name)
                                    {
                                        tds.eq(i).next().text("取消");
                                        tds.eq(i).next().next().text("退订");
                                        tds.eq(i).next().next().next().text(date);
                                    }

                                }


                            }
                        });
                    }


                }else{
                    alert(data.info);
                }
            }
        });
    }








    $(document).on("click",".pagination a",function(){

//        if(empty($("#province").val()))
//        {
//            alert("请选择省份!");
//            return false;
//        }

        layer.load();
        //return false;
        $.getJSON($(this).attr('href'),function(data){ 
       
            setTimeout(function(){
                layer.closeAll('loading');
            });
            $("table tbody").children().remove();
            $(".pagination").children().remove();

            if(data.status=="error"){
                // console.log('aaa');
                $("table tbody").append('<tr><td>没有数据!</td>');
            }
                            
            var adata = data;


            var id = ""

            var school_name = "";
            var agent_name = "";

            var classname = "";
            var stu_name = "";
            var parent_phone = "";
            var charging_phone = "";
            var package_name = "";
            var package = "";

            var addtime = "";


            // $("table tbody").children().remove();
            for (var i=0;i<adata.length;i++){
                          
                if(i==0)
                {
                    $(".pagination").append(adata[i]);
                    continue
                    //return false;
                }
                id = adata[i]['userid'];
                school_name = adata[i]['school_name'];
                agent_name = adata[i]['agent_name'];
                classname = adata[i]['classname'];
                stu_name = adata[i]['stu_name'];
                parent_phone = adata[i]['parent_phone'];
                charging_phone = adata[i]['charging_phone'];
                package  = adata[i]['package'];

                package_name = adata[i]['package_name'];



                var html=' ';

               if(charging_phone==null)
               {
                   charging_phone = '';
               }

                html+='<tr>';
                html+='<td style="   vertical-align: middle;"><input type="checkbox" class="J_check" name="ids[]" value='+id+'></td>'
                html+='<td style="vertical-align: middle;">'+school_name+'</td>';
                html+='<td style="vertical-align: middle;">'+agent_name+'</a></td>';
                html+='<td style="vertical-align: middle;">'+classname+'</td>';
                html+='<td style="vertical-align: middle;">'+stu_name+'</td>';
                html+='<td style="vertical-align: middle;"><a class="daibanzhuren1" data-toggle="modal" style="cursor: pointer;" >'+parent_phone+'</a></td>';
                html+='<td style="vertical-align: middle;">'+charging_phone+'</td>';
                html+='<td>'
                html+='<table  width=100% border=0 cellspacing=0 cellpadding=0 class=tables>';
                html+='<thead>';

                for (var j=0;j<package.length;j++){
                    if(package[j]["edit_time"]==null)
                    {
                        package[j]["edit_time"] = '暂无变更';
                    }
                    html+='<tr>';
                    html+='<td width="25%" style="border: none;" class=tds>'+package[j]["package_name"]+'</td>';
                    html+='<td width="15%" style="   border: none;">'+package[j]["use_status"]+'</td>';
                    html+='<td width="15%" style="    border: none;">'+package[j]["oder_status"]+'</td>';
                    html+='<td width="25%" style="    border: none;">'+package[j]["edit_time"]+'</td>';
                    html+='<td width="20%" style="    border: none;">'+package[j]["add_time"]+'</td>';
                    html+='</tr>';

                }

                html+='</thead>';
                html+='</table>';
                html+='</td>'

                html+='</tr>';


                $("table tbody").append(html);




            }
           
                            
        })
        return false; 

    })
    	



  



    $("#chaxun").click(function () {
        if(!$("#province").val())
        {
            alert("请选择省份!");
            return false;
        }
        if(!$("#citys").val())
        {
            alert("请选择市级!");
            return false;
        }
        if(!$("#message_type").val())
        {
            alert("请选择区级!");
            return false;
        }
        if(!$("#school").val())
        {
            alert("请选择学校!");
            return false;
        }
        var xuan = $(".tiaojian option:selected").val();
        var zhi = $(".zhi").val();
        var type = $(".select_3  option:selected").val();
        var typeschool = $(".chzn-select  option:selected").val();

        var isSuccess = 1;
        if(zhi == "") {
            if(xuan != 0) {
                var isSuccess = 0;
                alert("在选好条件在输入框中输入你要找的数据类型");

            }
        }
        if(xuan == 0) {
            if(zhi != "") {
                var isSuccess = 0;
                alert("请选择你要搜索的查询类型")
            }
        }
//        if(zhi == "" && xuan == 0) {
//            if(type == 0) {
//                alert("请选择地区");
//                var isSuccess = 0;
//            }
//            if(typeschool == "") {
//                var isSuccess = 0;
//                alert("请选择学校");
//            }
//        }
        if(isSuccess == 0) {
            return false;
        }
        var begin = $("input[name='begin']").val();

        var end = $("input[name='end']").val();


        if(begin || end)
        {
            if(end=='')
            {
                alert("请将时间输入完整!");
                return false;
            }
            if(begin=='')
            {
                alert("请将时间输入完整!");
                return false;
            }
        }


        layer.load();
        var schoolid = $("#school").val();

        // console.log(schoolid);
        // return false;
        var order = $("#order").find("option:selected").val();

        var classid = $("#classname").val();
        


              
        // var date = $("#time").val();
                  
        $.ajax({
            url:"__ROOT__/index.php/Admin/PracticeManage/customization_show",
            dataType:"json",
            type:"get",
            data:{
                      
                schoolid:schoolid,
                classid:classid,
                tiaojian:xuan,
                  shuzhi:zhi,
                  order:order,
                  begin:begin,
                    end:end,
            },
            success:function (res) {

                setTimeout(function(){
                    layer.closeAll('loading');
                });
                $("table tbody").children().remove();
                $(".pagination").children().remove();
                if(res.status=="error"){
                    // console.log('aaa');
                    $("table tbody").append('<tr><td>没有数据!</td>');
                }
                            
                var adata = res;



                var id = ""

                var school_name = "";
                var agent_name = "";

                var classname = "";
                var stu_name = "";
                var parent_phone = "";
                var charging_phone = "";
                var package_name = "";
                var package = "";

                var addtime = "";

                // $("table tbody").children().remove();
                for (var i=0;i<adata.length;i++){

                    if(i==0)
                    {
                        $(".pagination").append(adata[i]);
                        //return false;
                        continue
                    }

                    id = adata[i]['userid'];
                    school_name = adata[i]['school_name'];
                    agent_name = adata[i]['agent_name'];
                    classname = adata[i]['classname'];
                    stu_name = adata[i]['stu_name'];
                    parent_phone = adata[i]['parent_phone'];
                    charging_phone = adata[i]['charging_phone'];
                    package  = adata[i]['package'];

                    package_name = adata[i]['package_name'];

                    if(charging_phone==null)
                    {
                        charging_phone = '';
                    }


                  html = '';


                    html+='<tr>';
                    html+='<td style="   vertical-align: middle;"><input type="checkbox" class="J_check" name="ids[]" value='+id+'></td>'
                    html+='<td style="vertical-align: middle;">'+school_name+'</td>';
                    html+='<td style="vertical-align: middle;">'+agent_name+'</a></td>';
                    html+='<td style="vertical-align: middle;">'+classname+'</td>';
                    html+='<td style="vertical-align: middle;">'+stu_name+'</td>';
                    html+='<td style="vertical-align: middle;"><a class="daibanzhuren1" data-toggle="modal" style="cursor: pointer;">'+parent_phone+'</a></td>';
                    html+='<td style="vertical-align: middle;">'+charging_phone+'</td>';
                    html+='<td>'
                    html+='<table  width=100% border=0 cellspacing=0 cellpadding=0 class=tables>';
                        html+='<thead>';

                        for (var j=0;j<package.length;j++){
                        if(package[j]["edit_time"]==null)
                        {
                            package[j]["edit_time"] = '暂无变更';
                        }

                            html+='<tr>';
                             html+='<td width="25%" style="border: none;" class=tds>'+package[j]["package_name"]+'</td>';
                             html+='<td width="15%" style="   border: none;">'+package[j]["use_status"]+'</td>';
                             html+='<td width="15%" style="    border: none;">'+package[j]["oder_status"]+'</td>';
                             html+='<td width="20%" style="    border: none;">'+package[j]["edit_time"]+'</td>';
                             html+='<td width="25%" style="    border: none;">'+package[j]["add_time"]+'</td>';
                            html+='</tr>';

                         }

                        html+='</thead>';
                    html+='</table>';
                    html+='</td>'

                    html+='</tr>';

                    $("table tbody").append(html);

                }
            },
            error:function (res) {
                var data = eval(res.data);
//                            alert("失败");
                           
            }
        })

    });


/*复选框*/
    $(function() {
        $("#checkAll").click(function() {
            $('input[class="J_check"]').attr("checked",this.checked);
        });
        var $J_check = $("input[class='J_check']");
        $J_check.click(function(){
            $("#checkAll").attr("checked",$J_check.length == $("input[class='J_check']:checked").length ? true : false);
        });
    });









    function refersh_window() {
        var refersh_time = getCookie('refersh_time');
        if (refersh_time == 1) {
            window.location = "{:U('Notice/index',$formget)}";
        }
    }
    setInterval(function() {
        refersh_window();
    }, 2000);
    $(function() {
        setCookie("refersh_time", 0);
        Wind.use('ajaxForm', 'artDialog', 'iframeTools', function() {
            //批量移动
            $('.J_articles_move').click(
                function(e) {
                    var str = 0;
                    var id = tag = '';
                    $("input[name='ids[]']").each(function() {
                        if ($(this).attr('checked')) {
                            str = 1;
                            id += tag + $(this).val();
                            tag = ',';
                        }
                    });
                    if (str == 0) {
                        art.dialog.through({
                            id : 'error',
                            icon : 'error',
                            content : '您没有勾选信息，无法进行操作！',
                            cancelVal : '关闭',
                            cancel : true
                        });
                        return false;
                    }
                    var $this = $(this);
                    art.dialog.open(
                        "__ROOT__/index.php?g=portal&m=AdminPost&a=move&ids="
                        + id, {
                            title : "批量移动",
                            width : "80%"
                        });
                });
        });
    });
</script>
</body>
</html>