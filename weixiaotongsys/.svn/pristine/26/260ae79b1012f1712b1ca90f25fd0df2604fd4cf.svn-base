<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0">
    <!--<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />-->
    <title>{$schoolname}</title>
    <script src="__ROOT__/statics/wjs/jquery-3.0.0.min.js"></script>
    <link rel="stylesheet" href="__TMPL__public/css/zaixianQingjia.css">
    <link rel="stylesheet" href="__TMPL__public/css/top-box.css">
    <link rel="stylesheet" href="__TMPL__public/bootstrap/css/bootstrap.min.css" />
    <script type="text/javascript" src="__TMPL__public/bootstrap/js/bootstrap.min.js"></script>
    <link href="__TMPL__public/css/mobiscroll.css" rel="stylesheet" type="text/css">
    <script src="__TMPL__public/js/mobiscrolsddsl.js" type="text/javascript"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <style>
        #submit {
            width: 35%;
            height: 35px;
            border-radius: 10px;
            border: none;
            background-color: #06c18e;
            color: white;
            margin-top: 25px;
            margin-left: 30%;
            margin-bottom: 20px;
        }
            
        .kang {
            margin-top: 5px;
            width: 40px;
            height: 40px;
            border-radius: 35px;
        }
            
        #previewImage {
            width: 100%;
            cursor: pointer;
        }
            
        #previewImage div {
            float: left;
            width: 20%;
            margin-left: 4%;
        }
            
        #previewImage div img {
            width: 100%;
            margin-top: 15px;
            margin-left: 15px;
            height: calc(height);
            float:right;
        }
            
        .a-upload {
            height: 72px;
            width: 72px;
            float: left;
            position: relative;
            cursor: pointer;
            background: url(__TMPL__public/img/z_add.png) no-repeat center center;
            border: 1px solid #adadad;
            margin-top: 15px;
            margin-left: 20px;
            margin-bottom: 10px;
        }
            
        .a-upload input {
            top: 0;
            left: 0;
            width: 72px;
            height: 72px;
            opacity: 0;
            cursor: pointer;
        }
            
        #chooseImage {
            top: 0;
            left: 0;
            margin-left: 15px;
            width: 72px;
            height: 72px;
            opacity: 0;
            cursor: pointer;
        }
            
        * {
            padding: 0px;
            margin: 0px;
        }
            
        .content {
            width: 100%;
            height: 0px;
            background: #F27729;
            position: absolute;
            top: 40px;
        }
            
        .content .select {
            width: 100%;
            height: 40px;
            background: #FFFFFF;
            margin: 0px auto;
            position: relative;
            cursor: pointer;
        }
            
        .content .select::after {
            content: "";
            display: block;
            width: 10px;
            height: 10px;
            border-left: 1px solid #D0D0D0;
            border-bottom: 1px solid #D0D0D0;
            top: 12px;
            right: 12px;
            position: absolute;
            transform: rotate(-46deg);
            transition: all .3s ease-in;
        }
            
        .content .select p {
            width: 100%;
            line-height: 40px;
            font-size: 15px;
            font-family: "microsoft yahei";
            color: #666666;
            padding: 0px 8px;
        }
            
        .content .select ul {
            width: 100%;
            display: block;
            font-size: 16px;
            background: #FFFFFF;
            position: absolute;
            top: 30px;
            left: 0px;
            max-height: 0px;
            overflow: hidden;
            transition: max-height .3s ease-in;
        }
            
        .content .select ul li {
            width: 100%;
            height: 50px;
            line-height: 30px;
            padding: 0px 15px;
            list-style: none;
            color: #666666;
            border-bottom: 2px solid whitesmoke;
            border-top: 2px solid whitesmoke;
        }
            
        .content .select ul li.Selected {
            background: yellowgreen;
            color: #FFFFFF;
        }
            
        .content .select ul li:hover {
            background: #D0D0D0;
        }
            
        @-webkit-keyframes slide-down {
            0% {
                transform: scale(1, 0);
            }
            25% {
                transform: scale(1, 1.2);
            }
            50% {
                transform: scale(1, 0.85);
            }
            75% {
                transform: scale(1, 1.05);
            }
            100% {
                transform: scale(1, 1);
            }
        }
            
        .content .select.open ul {
            max-height: 250px;
            transform-origin: 50% 0;
            -webkit-animation: slide-down .5s ease-in;
            transition: max-height .2s ease-in;
        }
            
        .content .select.open::after {
            transform: rotate(134deg);
            transition: all .3s ease-in;
            top: 18px;
        }
            
        .top_bo {
            background-color: #06c18e;
            font-size: 15px;
            font-family: "微软雅黑 Light";
            font-weight: 600;
            line-height: 38px;
            color: white;
            text-align: center;
        }
            
        .top_bo img {
            width: 10px;
            position: absolute;
            top: 10px;
            left: 10px;
        }
            
        .cius {
            position: relative;
            margin-bottom: 15px;
            right: 0px;
            width: 100%;
            bottom: 10px;
            height: 40px;
            background-color: white;
            border: none;
            padding-left: 7px;
        }
            
        #jieshour {
            float: left;
            font-size: 15px;
            position: relative;
            right: 10px;
        }
            
        .ciusd {
            font-size: 15px;
        }
            
        .jiantou {
            float: right;
            position: relative;
            left: 15px;
        }
            
        .scc {
            float: right;
            background-color: white;
            width: 100%;
            height: 40px;
            position: relative;
            padding-left: 7px;
        }

        .delss {
            margin-top: 15px;
            color: #babfc7;
            background: rgba(0, 0, 0, 0.5);
            height: 35px;
            width: 19%;
            position: absolute;
            cursor :pointer;
        }
        .vx{
            float: right;
            font-size: 28px;
            text-align: center;
        }
    </style>

</head>

<body style="background-color: whitesmoke;">
<div id="zhezhao" style="z-index:99;width: 100%;height: 100%;position: fixed;top: 0;left: 0;background: rgba(0,0,0,0.6);display: none;"></div>
<div class="top_bo">
    <img src="__TMPL__public/img/img67.png" class="fanhui"> 在线请假
    <div class="clearfix"></div>

</div>



<!--<div class="last2" style="margin-top: 40px;height: 50px;">-->
<div class="last2" style="height: 50px;">
    <div class="word" style="width: 100%;">

        <button class="btn  btn-lg cius" data-toggle="modal" data-target="#myModal">
            <img  class="jiantou" src="__TMPL__public/img/img53.png" alt="">
            <span id="jieshour" class="kejian">接收人</span><span class="ciusd" style="position: absolute;right: 35px; color: dimgray;"></span>
                	
        </button>

    </div>

    <div class="clearfix"></div>
</div>

<div class="houdian">
    <div class="content">
        <!--<div class="select">-->
        <!--<p class="jiang">请假学生</p>-->
        <!--<ul id="jiangs">-->

        <!--</ul>-->
        <!--</div>-->

    </div>
</div>

<div class="last">
    <div class="word">
        <span class="kejian">开始时间</span><span></span>
    </div>
    <input style="float: right;border: none; text-align: right" value="" class="" readonly name="appDate" id="appDate" type="text" placeholder="点击此处选取时间">

    <div class="clearfix"></div>
</div>

<div class="last2">
    <div class="word">
        <span class="kejian">结束时间</span>
    </div>
    <input style="float: right;border: none; text-align: right" value="" class="" readonly name="appDate" id="appDates" type="text" placeholder="点击此处选取时间">
    <div class="clearfix"></div>
</div>
<div class="last2" style="padding-left: 3px;">


    <div class="dropdown">
        <button type="button" class="btn dropdown-toggle scc " id="dropdownMenu1" data-toggle="dropdown">
            <img class="jiantou" src="__TMPL__public/img/img53.png" alt="" >
            <div class="word" style="position: relative;">
                <span class="kejian" >请假类别</span>
            </div>
            <span class="iuy"  style="position: absolute;right: 35px;"></span>

        </button>
        <ul class="dropdown-menu pull-right" role="menu" aria-labelledby="dropdownMenu1">
            <li class="ie2" role="presentation">
                <a role="menuitem" tabindex="-1" href="#">病假</a>
            </li>
            <li class="ie4" role="presentation">
                <a role="menuitem" tabindex="-1" href="#">事假</a>
            </li>

        </ul>
    </div>

    <div class="clearfix"></div>

</div>
<div class="last2" style="padding-left: 3px;">
    <div>
        <textarea style=" margin-left: 8px;width: 100%;height: 80px;resize: none;border: none;outline: none;border-bottom: 1px solid #ebebeb;" placeholder="请输入你请假的内容" id="dzcontent"></textarea>
    </div>
    <div id="previewImage"></div>
    <a href="javascript:;" class="a-upload">
        <input type="button" id="chooseImage" value="上传">
    </a>
    <div class="clearfix"></div>
    <div style="background-color: brown;width: 100%;">

    </div>
</div>
<input type="hidden" value={$studentid} id="studentid">
<input type="hidden" value={$userid} id="userid">
<input type="hidden" value={$schoolid} id="schoolid">
<input type="hidden" value={$name} id="name">

<!-- 按钮触发模态框 -->

<!-- 模态框（Modal） -->
<div style="margin-top: 30px;" class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">接收人</h4>
            </div>
            <div class="modal-body">
                <!--中心内容-->
                <div class=" banji" style="height: 50px;width: 100%;background-color: whitesmoke;">
                    <span class="iou" style="position: relative;top: 14px;"></span>
                </div>
                <div class="jiuop" style="overflow:auto;height: 300px;">

                </div>
            </div>
            <!--<div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary">提交更改</button>
            </div>-->
        </div>
        <!-- /.modal-content -->
    </div>
    <!--老师ID-->
    <input type="hidden" class="teacheridG" value="" />
    <!--学生id-->
    <input type="hidden" id="jieshou" value="" />
    <!-- /.modal -->
</div>

<input type="submit" name="submit" id="submit" value="发布">
<script type="text/javascript">
    $(function() {
        var currYear = (new Date()).getFullYear();
        var opt = {};
        opt.date = {
            preset: 'date'
        };
        opt.datetime = {
            preset: 'datetime'
        };
        opt.time = {
            preset: 'time'
        };
        opt.default = {
            theme: 'android-ics light', //皮肤样式
            display: 'modal', //显示方式
            mode: 'scroller', //日期选择模式
            dateFormat: 'yyyy-mm-dd',
            lang: 'zh',
            showNow: true,
            nowText: "今天",
            startYear: currYear, //开始年份
            endYear: currYear + 100 //结束年份
        };

        $("#appDate").mobiscroll($.extend(opt['date'], opt['default']));
        $("#appDates").mobiscroll($.extend(opt['date'], opt['default']));

        var optDateTime = $.extend(opt['datetime'], opt['default']);
        var optTime = $.extend(opt['time'], opt['default']);
        $("#appDateTime").mobiscroll(optDateTime).datetime(optDateTime);
        $("#appTime").mobiscroll(optTime).time(optTime);
    });
</script>

<script>
    //苹果去掉alert 网址
    window.alert = function(name){
        var iframe = document.createElement("IFRAME");
        iframe.style.display="none";
        iframe.setAttribute("src", 'data:text/plain,');
        document.documentElement.appendChild(iframe);
        window.frames[0].window.alert(name);
        iframe.parentNode.removeChild(iframe);
    };

    $("document").ready(function() {
        var userid = $("#userid").val();
        var schoolid = $("#schoolid").val();

        $(".cius").click(function() {
            var studentid = $("#studentid").val();

            $(".jiuop").text("");
            if (studentid == "") {
                alert("请选择请假学生");
                $('.cius').prop('disabled', true);
            } else {
                $.ajax({
                    type: "post",
                    url: '__ROOT__/index.php/?g=apps&m=teacher&a=getstudentclasslistandteacherlist',
                    async: true,
                    data: {
                        studentid: studentid,
                        schoolid:schoolid
                    },
                    dataType: 'json',
                    success: function(res) {
                        var htmls = "";
                        res = eval(res.data);
                        for (var i = 0; i < res.length; i++) {
                            var classname = res[i].classname; //学生所在的班级
                            for (var k = 0; k < res[i].teacherlist.length; k++) {
                                var name = res[i].teacherlist[k].name; //老师的名字
                                var photo = res[i].teacherlist[k].photo; //老师的照片
                                var idf = res[i].teacherlist[k].id; //老师ID
                                htmls += '<div   data-dismiss="modal"  class="uio"  style="margin-top: 10px;">';
                                htmls += '<span><img src="{$Think.const.SR}' + photo + '" style="width: 50px;height: 50px;border-radius: 35px;"/></span>';
                                htmls += '<input type="hidden" class="teacherids" value="' + idf + '"/>';
                                htmls += '<span class="huoqu" style="margin-left:3%;">' + name + '</span>';
                                htmls += '</div>'
                            }
                        }
                        $(".jiuop").append(htmls);
                        $(".iou").text(classname);
                        $(".uio").click(function() {
                            var mui = $(".huoqu", this).text();
//                                    $(".ciusd").text(mui);
                            $("#jieshour").text(mui);
                            var zhis = $(".teacherids", this).val();
                            $(".teacheridG").val(zhis);
                        })

                    },
                    error: function() {
                        console.log('系统错误,请稍后重试');
                    }
                });
            }

        })
    })



    //
    $(".ie2").click(function() {
        var zhi = $(".ie2").text();
        $(".iuy").text(zhi);
    })
    $(".ie4").click(function() {
        var zhi1 = $(".ie4").text();
        $(".iuy").text(zhi1);
    })

    //取消没有选择请假人的禁用按钮
    $(".cius").mouseover(function() {
        $(".cius").removeAttr("disabled");
    })
</script>

<script>
    wx.config({
        debug: false,
        appId: '{$signPackage.appId}',
        timestamp: '{$signPackage.timestamp}',
        nonceStr: '{$signPackage.nonceStr}',
        signature: '{$signPackage.signature}',
        jsApiList: [
            //这里要写调用的api列表
            'checkJsApi', 'onMenuShareTimeline', 'chooseImage', 'previewImage', 'uploadImage', 'downloadImage','hideMenuItems','hideAllNonBaseMenuItem',
        ]
    });
    wx.ready(function(){
        //批量隐藏功能
        wx.hideMenuItems({
            menuList: ['menuItem:share:qq',
                'menuItem:share:weiboApp',
                'menuItem:favorite',
                'menuItem:share:facebook',
                'menuItem:share:QZone',
                'menuItem:share:timeline',
                'menuItem:share:appMessage',
                'menuItem:copyUrl',
                'menuItem:share:email',
                'menuItem:openWithQQBrowser',
                'menuItem:exposeArticle',
                'menuItem:setFont'

            ] // 要隐藏的菜单项，只能隐藏“传播类”和“保护类”按钮，所有menu项见附录3
        });
        wx.hideAllNonBaseMenuItem();
    });
    var localId = [];
    var serverId = [];
    var newId=[];
    $("#chooseImage").click(function() {
        //这里是定义一个css的排序
        var imgs = "";
        var html = "";
        wx.chooseImage({
            count: 9,
            // 默认9
            sizeType: ['original', 'compressed'],
            // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['album', 'camera'],
            // 可以指定来源是相册还是相机，默认二者都有
            success: function(res) {
                localId = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                for (var i = 0; i < localId.length; i++) {
                    imgs = localId[i];
                    html = "<div><img src='" + imgs + "' /><a class='delss' value="+imgs+"><p class='vx'>×</p></a></div>";
                    $("#previewImage").append(html);
                    setTimeout(function() {
                            $('#previewImage div img').css('height', $('#previewImage div img').css('width'));
                        },
                        100);
                }
                for (var z = 0; z < localId.length; z++) {
                    newId.push(localId[z]);
                }
            }

        });

    });
    $(document).on('click','#previewImage',function(){
        var imgObj = $('#previewImage div img');
        var imgsurl = [];
        var imgSrc = "";
        for (var j = 0; j < imgObj.length; j++) {
            imgsurl[j] = imgObj[j].src;
            imgSrc += imgObj[j].src + ",";
            (function(j) {
                imgObj.eq(j).click(function() {
                    wx.previewImage({
                        current: imgObj[j].src,
                        // 当前显示图片的http链接
                        urls: imgsurl // 需要预览的图片http链接列表
                    });
                });
            })(j)
        }
    });
    $(function(){
        var ua = navigator.userAgent.toLowerCase();
        if (/iphone|ipad|ipod/.test(ua)) {
            $(document).on('touchend','.delss',function(){
                $(this).parent().remove();
                var image = $(this).attr("value");
                newId.splice($.inArray(image,newId),1);
            });
        } else {
            $(document).on('click','.delss',function(){
                $(this).parent().remove();
                var image = $(this).attr("value");
                newId.splice($.inArray(image,newId),1);
            });
        }
    });


    $('#submit').click(function() {
        var  btime = $("#appDate").val();
        var begintime = new Date(Date.parse(btime.replace(/-/g, "/")));
        begintime = begintime.getTime();
        begintime = begintime/1000;
//                var name = $(".jiang").text();
        var name = $("#name").val();
        var endtime = $("#appDates").val();
        var etime = new Date(Date.parse(endtime.replace(/-/g, "/")));
        endtime = etime.getTime();
        endtime = endtime/1000;
        var userid = $("#userid").val();
        var schoolid = $("#schoolid").val();

//                var studentid = $("#jieshou").val();
        var studentid = $("#studentid").val();
        var teacherid = $('.teacheridG').val();
        var title = $("#title").val();
        var content = $("#dzcontent").val();
        var leavetype = $(".iuy").text();
        leavetype = leavetype.replace(/\s/ig,'');
        if (!studentid || studentid == "") {
            alert("请选择请假学生");
            return;
        }
        if (!teacherid || teacherid == "") {
            alert('请选择接收人');
            return;
        }
        if (!begintime || begintime == "") {
            alert('请选择开始时间');
            return;
        }
        if (!endtime || endtime == "") {
            alert('请选择结束时间');
            return;
        }
        if(begintime>endtime){
            alert("结束时间要大于开始时间");
            return;
        }
        if (!leavetype || leavetype == "") {
            alert('请选择请假类别');
            return;
        }
        if (!content || content == "") {
            alert('内容不能为空');
            return;
        }
//                else if(content.length>50){
//                    alert("内容字数不能超过50个字数");
//                    return;
//                }
        localId = newId;
        if (localId.length == 0) {
            $('#zhezhao').show();
            $.ajax({
                url: "__ROOT__/index.php?g=apps&m=student&a=addleave",
                type: "post",
                dataType: "json",
                data: {
                    begintime:begintime,
                    endtime: endtime,
                    picture_url: "",
                    studentid: studentid,
                    teacherid: teacherid,
                    parentid: userid,
                    reason: content,
                    leavetype:leavetype,
                    schoolid:schoolid
                },
                success: function(res) {
                    if(res.status=="error"){
                        $('#zhezhao').hide();
                        alert(res.data);
                        return;
                    }
                    var content = $("#dzcontent").val();
                    $.ajax({
                        url: "__ROOT__/index.php/Apps/SendTpl/Leave",
                        type: "post",
                        dataType: "json",
                        data: {
                            userid: userid,
                            receiveid:teacherid,
                            begintime:begintime,
                            endtime:endtime,
                            name:name,
                            schoolid:schoolid,
                            content: content

                        },
                        success: function(res) {

                        },
                        error: function(res) {
                            console.log(res);
                        }
                    });
                    $('#zhezhao').hide();
                    alert("请假成功,请等待老师的答复");
                    location.href = "{:U('index')}";
                },
                error: function(res) {
                    //alert("请假失败 请稍后重试");
                }
            });
            return;
        }
        $('#zhezhao').show();
        var picurl = "";
        var i = 0,
            serverId = [];

        length = localId.length;
        function upload() {
            wx.uploadImage({
                localId: localId[i],
                success: function(res1) {
                    i++;
                    serverId.push(res1.serverId);
                    $.ajax({
                        url: "__ROOT__/index.php/Apps/Index/download",
                        type: "post",
                        dataType: "json",
                        data: {
                            serverId: res1.serverId
                        },
                        success: function(res) {
                            if(res.status=="error"){
                                alert("图片上传失败");
                                return;
                            }
                            var img = res.data.filename+":"+res.data.width+":"+res.data.height+",";
                            picurl += img;
                            if (i < length) {
                                upload();
                            } else {
                                $.ajax({
                                    url: "__ROOT__/index.php?g=apps&m=student&a=addleave",
                                    type: "post",
                                    dataType: "json",
                                    data: {
                                        begintime:begintime,
                                        endtime: endtime,
                                        picture_url: picurl,
                                        leavetype:leavetype,
                                        studentid: studentid,
                                        parentid: userid,
                                        teacherid: teacherid,
                                        reason: content,
                                        schoolid:schoolid
                                    },
                                    success: function(res) {
                                        if(res.status=="error"){
                                            $('#zhezhao').hide();
                                            alert(res.data);
                                            return;
                                        }
                                        var content = $("#dzcontent").val();
//                                                console.log(res);
                                        $.ajax({
                                            url: "__ROOT__/index.php/Apps/SendTpl/Leave",
                                            type: "post",
                                            dataType: "json",
                                            data: {
                                                userid: userid,
                                                receiveid:teacherid,
                                                begintime:begintime,
                                                endtime:endtime,
                                                name:name,
                                                schoolid:schoolid,
                                                content: content
                                            },
                                            success: function(res) {
                                            },
                                            error: function(res) {
                                            }
                                        });
                                        $('#zhezhao').hide();
                                        alert("请假成功,请等待老师的答复");
                                        location.href = "{:U('index')}";
//
                                    },
                                    error: function(res) {
                                        alert("网络异常 请稍后重试");
                                    }
                                });
                                //console.log("哦执行了没");
                            }
                        },
                        error: function(res3) {
                            //console.log(3);
                        }
                    });
                },
                fail: function(res4) {
                    alert("图片上传失败,请稍后再试");
                }
            });
        }
        upload();
    });
    $(".fanhui").click(function() {
        //window.history.go(-1);
        location.href = "{:U('index')}"
    })
</script>
</body>

</html>