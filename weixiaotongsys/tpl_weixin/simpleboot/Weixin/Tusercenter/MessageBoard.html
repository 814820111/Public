<!doctype html>
<html>

<head>
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <style>
        .clearfix:after {content: "."; display: block; height:0; clear:both; visibility: hidden;}
        .clearfix { *zoom:1; }
        .neirong {
            padding: 0;
        }
        
        .massage {
            width: 100%;

        }
        
        #previewImage {
            width: 100%;
            cursor: pointer;
        }
        
        #previewImage div {
            float: left;
            width: 20%;
            margin-left: 4%;
        }
        
        #previewImage div img {
            width: 100%;
            height: calc(height);
            float: right;
        }
        
        .a-upload {
            height: 72px;
            width: 72px;
            float: left;
            position: relative;
            cursor: pointer;
            background: url(__TMPL__public/img/z_add.png) no-repeat center center;
            border: 1px solid #adadad;
            margin-top: 20px;
            margin-left: 17px;
            margin-bottom: 10px;
        }
        
        .a-upload input {
            top: 0;
            left: 0;
            width: 72px;
            height: 72px;
            opacity: 0;
            cursor: pointer;
        }
        
        #chooseImage {
            top: 0;
            left: 0;
            width: 72px;
            height: 72px;
            opacity: 0;
            cursor: pointer;
        }
        a:hover{
            -webkit-tap-highlight-color:rgba(0,0,0,0);
            -webkit-tap-highlight-color: transparent;

        }
        .jiu {
            background-color: white;
            padding: 15px 10px;
            height: 40px;
        }
        .delss {
            margin-top: 20px;
            color: #babfc7;
            background: rgba(0, 0, 0, 0.5);
            height: 35px;
            width: 20%;
            position: absolute;
            cursor :pointer;
        }
        .vx{
            float: right;
            font-size: 28px;
            text-align: center;
        }
    </style>

    <title>{$schoolname}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="__TMPL__public/css/tianjiadingzhu.css">
    <link rel="stylesheet" href="__TMPL__public/css/zaixianLiuyan.css">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
    <link rel="stylesheet" href="__TMPL__public/css/top-box.css">
    <!--<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.js"></script>-->
    <!--<script src="http://apps.bdimg.com/libs/zepto/1.1.4/zepto.min.js"></script>-->
    <script src="__ROOT__/statics/wjs/jquery-3.0.0.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <link rel="stylesheet" type="text/css" href="__TMPL__Public/Tchcss/commes.css" />
    <link rel="stylesheet" href="__TMPL__Public/Tchcss/photoswipe.css" />
    <link rel="stylesheet" href="__TMPL__Public/Tchcss/default-skin/default-skin.css" />
    <script src="__TMPL__Public/js/photoswipe.min.js"></script>
    <script src="__TMPL__Public/js/photoswipe-ui-default.min.js"></script>
</head>


<body>
<div id="zhezhao" style="z-index:99;width: 100%;height: 100%;position: fixed;top: 0;left: 0;background: rgba(0,0,0,0.6);display: none;"></div>
    <!--
    @param发布留言
    @param 2017年4月1日13:53:20
-->
    <input type="hidden" value={$userid} id="userid">
    <div class="top_box" style="z-index: 80;">
        <a href="__ROOT__/index.php/weixin/Tusercenter"><img src="__ROOT__/statics/img/img67.png" class="fanhui"></a>
        在线留言
        <div class="clearfix"></div>
    </div>
    <!--
@param 留言内容
@param desc 留言内容
@param 2017年4月1日13:54:19
-->
    <div class="bigbox" style="margin-top: 40px;">
        <div class="neirong" style="padding: 10px;  background-color: white;margin-top: 10px">
            <input type="text" name="desc" value="" id="desc" placeholder="留言内容" style="font-size:15px;width:100%;height:100px;border: none;margin-left: 10px">
            <div class="clearfix"></div>
        </div>
        <div id="previewImage"></div>
        <a href="javascript:;" class="a-upload">
            <input type="button" id="chooseImage" value="上传">
        </a>
        <div class="clearfix"></div>
    </div>
    <div class="queren" id="submit">发&nbsp;&nbsp;送</div>

    <div class="history">
        <span class="hist">历史留言信息：</span>

    </div>
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="pswp__bg"></div>
        <div class="pswp__scroll-wrap">
            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>
            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    <div class="pswp__counter"></div>
                    <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                            <div class="pswp__preloader__cut">
                                <div class="pswp__preloader__donut"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div>
                </div>
                <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
                <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>
        </div>

    </div>

</body>

<!--
    @param 用到什么值就改动什么值
    @param useri 用户id schoolid 学校id classid 班级id
    @param 2017年4月1日11:36:06
-->
<script>
    wx.config({
        debug: false,
        appId: '{$signPackage.appId}',
        timestamp: '{$signPackage.timestamp}',
        nonceStr: '{$signPackage.nonceStr}',
        signature: '{$signPackage.signature}',
        jsApiList: [
            //这里要写调用的api列表
            'checkJsApi', 'onMenuShareTimeline', 'chooseImage', 'previewImage', 'uploadImage', 'downloadImage','hideMenuItems','hideAllNonBaseMenuItem',
        ]
    });

    wx.ready(function(){
        //批量隐藏功能
        wx.hideMenuItems({
            menuList: ['menuItem:share:qq',
                'menuItem:share:weiboApp',
                'menuItem:favorite',
                'menuItem:share:facebook',
                'menuItem:share:QZone',
                'menuItem:share:timeline',
                'menuItem:share:appMessage',
                'menuItem:copyUrl',
                'menuItem:share:email',
                'menuItem:openWithQQBrowser',
                'menuItem:exposeArticle',
                'menuItem:setFont'

            ] // 要隐藏的菜单项，只能隐藏“传播类”和“保护类”按钮，所有menu项见附录3
        });
        wx.hideAllNonBaseMenuItem();
    });
    var localId = [];
    var serverId = [];
    var newId=[];
    $("#chooseImage").click(function() {
        //这里是定义一个css的排序
        var imgs = "";
        var html = "";
        wx.chooseImage({
            count: 9,
            // 默认9
            sizeType: ['original', 'compressed'],
            // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['album', 'camera'],
            // 可以指定来源是相册还是相机，默认二者都有
            success: function(res) {
                localId = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                for (var i = 0; i < localId.length; i++) {
                    imgs = localId[i];
                    html = "<div><img src='" + imgs + "' /><a class='delss' value="+imgs+"><p class='vx'>×</p></a></div>";
                    $("#previewImage").append(html);
                    setTimeout(function() {
                            $('#previewImage div img').css('height', $('#previewImage div img').css('width'));
                        },
                        100);
                }
                for (var z = 0; z < localId.length; z++) {
                    newId.push(localId[z]);
                }
            }
        });

    });
    $(document).on('click','#previewImage',function(){
        var imgObj = $('#previewImage div img');
        var imgsurl = [];
        var imgSrc = "";
        for (var j = 0; j < imgObj.length; j++) {
            imgsurl[j] = imgObj[j].src;
            imgSrc += imgObj[j].src + ",";
            (function(j) {
                imgObj.eq(j).click(function() {
                    wx.previewImage({
                        current: imgObj[j].src,
                        // 当前显示图片的http链接
                        urls: imgsurl // 需要预览的图片http链接列表
                    });
                });
            })(j)
        }
    });
    $(function(){
        var ua = navigator.userAgent.toLowerCase();
        if (/iphone|ipad|ipod/.test(ua)) {
            $(document).on('touchend','.delss',function(){
                $(this).parent().remove();
                var image = $(this).attr("value");
                newId.splice($.inArray(image,newId),1);
            });
        } else {
            $(document).on('click','.delss',function(){
                $(this).parent().remove();
                var image = $(this).attr("value");
                newId.splice($.inArray(image,newId),1);
            });
        }
    });

    //苹果去掉alert 网址
    window.alert = function(name){
        var iframe = document.createElement("IFRAME");
        iframe.style.display="none";
        iframe.setAttribute("src", 'data:text/plain,');
        document.documentElement.appendChild(iframe);
        window.frames[0].window.alert(name);
        iframe.parentNode.removeChild(iframe);
    };
    var userid = $("#userid").val();
    $('#submit').click(function() {
        var title = $("#title").val();
        var content = $("#desc").val();
        if (!content) {
            alert('内容不能为空');
            return;
        }
        localId = newId;
        if (localId.length == 0) {
            $.ajax({
                url: "__ROOT__/index.php?g=apps&m=index&a=LeaveMessage",
                type: "post",
                dataType: "json",
                data: {
                    userid: userid,
                    photo: "",
                    message: content
                },
                success: function(res) {
                    alert("发送成功");
                    location.reload();
                },
                error: function(res) {
                    alert("发送失败 请稍后重试");
                }
            });
            return;
        }
        $('#zhezhao').show();
        var picurl = "";
        var i = 0,
        serverId = [];

        length = localId.length;
        function upload() {
            wx.uploadImage({
                localId: localId[i],
                success: function(res1) {
                    i++;
                    serverId.push(res1.serverId);
                    $.ajax({
                        url: "__ROOT__/index.php/Apps/Index/download",
                        type: "post",
                        dataType: "json",
                        data: {
                            serverId: res1.serverId,
                        },
                        success: function(res) {
                            if(res.status=="error"){
                                alert("图片上传失败");
                                return;
                            }
                            var img = res.data.filename+":"+res.data.width+":"+res.data.height+",";
                            picurl += img;
                            if (i < length) {
                                upload();
                            } else {
                                $.ajax({
                                    url: "__ROOT__/index.php?g=apps&m=index&a=LeaveMessage",
                                    type: "post",
                                    dataType: "json",
                                    data: {
                                        userid: userid,
                                        photo: picurl,
                                        message: content
                                    },
                                    success: function(res) {
                                        $('#zhezhao').hide();
                                        alert("发送成功");
                                        location.reload()
                                    },
                                    error: function(res) {
                                        alert("发送失败 请稍后重试");
                                    }
                                });
                            }
                        },
                        error: function(res3) {
                            //console.log(3);
                        }
                    });
                },
                fail: function(res4) {

                    alert("发送失败 请稍后重试");
                }
            });
        }
        upload();
    });
</script>
<script>
    var html = "";
    $("document").ready(function() {
        var userid = $("#userid").val();
        $.ajax({
            url: "__ROOT__/index.php?g=apps&m=index&a=GetLeaveMessageBySelf",
            dataType: "json",
            type: "POST",
            data: {
                userid: userid
            },
            success: function(res) {
                var res = eval(res.data);
                console.log(res);
                function getLocalTime(nS) {
                    return new Date(parseInt(nS) * 1000).toLocaleString().replace(/:\d{1,2}$/, ' ');
                }
                for (var i = 0; i < res.length; i++) {
                    //                    var feed_back = res[i]["feed_back"];
                    var feed_back = res[i]["feed_back"];
                    var message = res[i]['message'];
                    var time = res[i]["create_time"];
                    var feed_time = res[i]["feed_time"];
                    var photo = res[i]["photo"];
                    photo = photo.substring(0, photo.length - 1);
                    var test = new Array();
                    test = photo.split(",");
                    for(var z = 0;z<test.length;z++){
                        if(test[z]==''||test[z]==null||typeof(test[z])==undefined){
                            test.splice(z,1);
                            z=z-1;
                        }
                    }
                    var img = "";
                    html += '<div class="aaaa">'
                    var num=test.length;
                    if(num==1){
                        html += '<div style="margin-left:5px;width:100%;max-height:300px;" class="my">'
                        for (var g = 0; g < test.length; g++) {
//                            var zhaopian = test[g]; //内容照片
//                            var  height = 800;
//                            var width = 600;
                            image = test[g].split(":");
                            var zhaopian = image[0]; //内容照片
                            var width = image[1];
                            if(width){
                                width = width;
                            }else{
                                width = 800;
                            }
                            var  height = image[2];
                            if(height){
                                height =height;
                            }else{
                                height = 800;
                            }
                            html += '<figure>'
                            html += ' <a href="{$Think.const.SRHB}' + zhaopian + '" data-size="'+width+'x'+height+'">'
                            html += '<img  style="max-width:250px;max-height:250px;width: 100%;" src="{$Think.const.SR}' + zhaopian + '"/>'
                            html += '</a>'
                            html += '</figure>'
                        }
                        html += '</div>'
                    }else{
                        html += '<div style="margin-left:5px;" class="my-gallery">'
                        for (var g = 0; g < test.length; g++) {
//                            var zhaopian = test[g]; //内容照片
//                            var height = 800;
//                            var width = 600;
                            image = test[g].split(":");
                            var zhaopian = image[0]; //内容照片
                            var width = image[1];
                            if(width){
                                width = width;
                            }else{
                                width = 800;
                            }
                            var  height = image[2];
                            if(height){
                                height =height;
                            }else{
                                height = 800;
                            }
                            html += '<figure>'
                            html += ' <a href="{$Think.const.SRHB}' + zhaopian + '" data-size="'+width+'x'+height+'">'
                            html += '<img style="width: 100%;height: auto;" src="{$Think.const.SR}' + zhaopian + '" />'
                            html += '</a>'
                            html += '</figure>'
                        }
                        html += '</div>'
                    }
//                    for (j = 0; j < test.length; j++) {
//                        if(test[j]){
//                            var imgsrc = "<img src = '{$Think.const.SR}" + test[j] + "' style='width: 75px;height: 75px;display: inline-block;'>";
//                            img += imgsrc;
//                        }
//
//                    }
                    html += '</div>'
//                    if (feed_back == "" && photo == "") {
//                        html += '<div class="massage"> <div class="question"> <div class="left"><img src="__ROOT__/statics/img/1.png" alt=""></div> <p class="right">' + message + '</p> <div class="clearfix"></div> </div> <div class="time">' + getLocalTime(time) + '</div><div class="clearfix"> ' + img + '<div><hr class="divide"><div class="reply"> <div class="left"> <img src="__ROOT__/statics/img/2.png" alt=""> </div> <p class="right">暂无回复内容</p> <div class="time">' + getLocalTime(feed_time) + ' </div></div> </div>';
                        html += '<div class="massage"> <div class="question"> <div class="left"><img src="__ROOT__/statics/img/1.png" alt=""></div> <p class="right">' + message + '</p> <div class="clearfix"></div> </div> <div class="time">' + getLocalTime(time) + '</div><div class="clearfix"> ' + img + '<div><hr class="divide"><div class="reply"> <div class="left"> <img src="__ROOT__/statics/img/2.png" alt=""> </div> <p class="right">暂无回复内容</p> <div class="time">' + getLocalTime(feed_time) + ' </div></div> </div>';
//                    } else if (feed_back !== "") {
//                        html += '<div class="massage"> <div class="question"> <div class="left"><img src="__ROOT__/statics/img/1.png" alt=""></div> <p class="right">' + message + '</p> <div class="clearfix"></div> </div> <div class="time">' + getLocalTime(time) + '</div><div class="clearfix">' + img + '</div><hr class="divide"> <div class="reply"> <div class="left"> <img src="__ROOT__/statics/img/2.png" alt=""> </div> <p class="right">' + feed_back + '</p><div class="time">' + getLocalTime(feed_time) + ' </div> </div> </div>';
//                    } else if (photo !== "" && message !== "") {
//                        html += '<div class="massage"> <div class="question"> <div class="left"><img src="__ROOT__/statics/img/1.png" alt=""></div> <p class="right">' + message + '</p> <div class="clearfix"></div> </div> <div class="time">' + getLocalTime(time) + '</div><div class="clearfix">' + img + '</div><hr class="divide"> <div class="reply"> <div class="left"> <img src="__ROOT__/statics/img/2.png" alt=""> </div> <p class="right">' + feed_back + '</p><div class="time">' + getLocalTime(feed_time) + ' </div> </div> </div>';
//                    }

                }
                $(".history").append(html);
                var img_width = $(".my-gallery img").width()
                $(".my-gallery img").height(img_width)
                var initPhotoSwipeFromDOM = function(gallerySelector) {

                    // parse slide data (url, title, size ...) from DOM elements
                    // (children of gallerySelector)
                    var parseThumbnailElements = function(el) {
                        var thumbElements = el.childNodes,
                            numNodes = thumbElements.length,
                            items = [],
                            figureEl,
                            linkEl,
                            size,
                            item;

                        for (var i = 0; i < numNodes; i++) {

                            figureEl = thumbElements[i]; // <figure> element

                            // include only element nodes
                            if (figureEl.nodeType !== 1) {
                                continue;
                            }

                            linkEl = figureEl.children[0]; // <a> element

                            size = linkEl.getAttribute('data-size').split('x');

                            // create slide object
                            item = {
                                src: linkEl.getAttribute('href'),
                                w: parseInt(size[0], 10),
                                h: parseInt(size[1], 10)
                            };



                            if (figureEl.children.length > 1) {
                                // <figcaption> content
                                item.title = figureEl.children[1].innerHTML;
                            }

                            if (linkEl.children.length > 0) {
                                // <img> thumbnail element, retrieving thumbnail url
                                item.msrc = linkEl.children[0].getAttribute('src');
                            }

                            item.el = figureEl; // save link to element for getThumbBoundsFn
                            items.push(item);
                        }

                        return items;
                    };

                    // find nearest parent element
                    var closest = function closest(el, fn) {
                        return el && (fn(el) ? el : closest(el.parentNode, fn));
                    };

                    // triggers when user clicks on thumbnail
                    var onThumbnailsClick = function(e) {
                        e = e || window.event;
                        e.preventDefault ? e.preventDefault() : e.returnValue = false;

                        var eTarget = e.target || e.srcElement;

                        // find root element of slide
                        var clickedListItem = closest(eTarget, function(el) {
                            return (el.tagName && el.tagName.toUpperCase() === 'FIGURE');
                        });

                        if (!clickedListItem) {
                            return;
                        }

                        // find index of clicked item by looping through all child nodes
                        // alternatively, you may define index via data- attribute
                        var clickedGallery = clickedListItem.parentNode,
                            childNodes = clickedListItem.parentNode.childNodes,
                            numChildNodes = childNodes.length,
                            nodeIndex = 0,
                            index;

                        for (var i = 0; i < numChildNodes; i++) {
                            if (childNodes[i].nodeType !== 1) {
                                continue;
                            }

                            if (childNodes[i] === clickedListItem) {
                                index = nodeIndex;
                                break;
                            }
                            nodeIndex++;
                        }



                        if (index >= 0) {
                            // open PhotoSwipe if valid index found
                            openPhotoSwipe(index, clickedGallery);
                        }
                        return false;
                    };

                    // parse picture index and gallery index from URL (#&pid=1&gid=2)
                    var photoswipeParseHash = function() {
                        var hash = window.location.hash.substring(1),
                            params = {};

                        if (hash.length < 5) {
                            return params;
                        }

                        var vars = hash.split('&');
                        for (var i = 0; i < vars.length; i++) {
                            if (!vars[i]) {
                                continue;
                            }
                            var pair = vars[i].split('=');
                            if (pair.length < 2) {
                                continue;
                            }
                            params[pair[0]] = pair[1];
                        }

                        if (params.gid) {
                            params.gid = parseInt(params.gid, 10);
                        }

                        return params;
                    };

                    var openPhotoSwipe = function(index, galleryElement, disableAnimation, fromURL) {
                        var pswpElement = document.querySelectorAll('.pswp')[0],
                            gallery,
                            options,
                            items;

                        items = parseThumbnailElements(galleryElement);

                        // define options (if needed)
                        options = {
                            fullscreenEl : false,
                            //点击图片关闭
                            tapToClose: true,
                            // define gallery index (for URL)
                            galleryUID: galleryElement.getAttribute('data-pswp-uid'),
                            getThumbBoundsFn: function(index) {
                                // See Options -> getThumbBoundsFn section of documentation for more info
                                var thumbnail = items[index].el.getElementsByTagName('img')[0], // find thumbnail
                                    pageYScroll = window.pageYOffset || document.documentElement.scrollTop,
                                    rect = thumbnail.getBoundingClientRect();

                                return {
                                    x: rect.left,
                                    y: rect.top + pageYScroll,
                                    w: rect.width
                                };
                            }

                        };

                        // PhotoSwipe opened from URL
                        if (fromURL) {
                            if (options.galleryPIDs) {
                                // parse real index when custom PIDs are used
                                // http://photoswipe.com/documentation/faq.html#custom-pid-in-url
                                for (var j = 0; j < items.length; j++) {
                                    if (items[j].pid == index) {
                                        options.index = j;
                                        break;
                                    }
                                }
                            } else {
                                // in URL indexes start from 1
                                options.index = parseInt(index, 10) - 1;
                            }
                        } else {
                            options.index = parseInt(index, 10);
                        }

                        // exit if index not found
                        if (isNaN(options.index)) {
                            return;
                        }

                        if (disableAnimation) {
                            options.showAnimationDuration = 0;
                        }

                        // Pass data to PhotoSwipe and initialize it
                        gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);
                        gallery.init();
                    };

                    // loop through all gallery elements and bind events
                    var galleryElements = document.querySelectorAll(gallerySelector);

                    for (var i = 0, l = galleryElements.length; i < l; i++) {
                        galleryElements[i].setAttribute('data-pswp-uid', i + 1);
                        galleryElements[i].onclick = onThumbnailsClick;
                    }

                    // Parse URL and open gallery if it contains #&pid=3&gid=1
                    var hashData = photoswipeParseHash();
                    if (hashData.pid && hashData.gid) {
                        openPhotoSwipe(hashData.pid, galleryElements[hashData.gid - 1], true, true);
                    }
                };

                // execute above function
                initPhotoSwipeFromDOM('.my-gallery');
                initPhotoSwipeFromDOM('.my');
            },
            error: function(res) {}
        });
    });
</script>

</html>